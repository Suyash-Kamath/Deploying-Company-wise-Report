<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insurance Policy Processing System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f4f9;
        }
        .sidebar {
            background-color: #1e3a8a;
            color: white;
            height: 100vh;
            padding: 1.5rem;
            position: fixed;
            width: 300px;
        }
        .main-content {
            margin-left: 320px;
            padding: 2rem;
        }
        .tab {
            display: none;
        }
        .tab.active {
            display: block;
        }
        .tab-button {
            background-color: #e5e7eb;
            padding: 0.5rem 1rem;
            margin-right: 0.5rem;
            cursor: pointer;
            border-radius: 0.25rem;
        }
        .tab-button.active {
            background-color: #3b82f6;
            color: white;
        }
        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .error-message {
            color: #dc2626;
            font-weight: bold;
        }
        .success-message {
            color: #16a34a;
            font-weight: bold;
        }
        .info-message {
            color: #3b82f6;
            font-weight: bold;
        }
        .spinner {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2 class="text-2xl font-bold mb-6">📁 File Upload</h2>
        <div class="mb-4">
            <label for="company-name" class="block text-sm font-medium mb-1">Company Name</label>
            <input type="text" id="company-name" value="Unknown Company" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600">
        </div>
        <div class="mb-4">
            <label for="policy-file" class="block text-sm font-medium mb-1">📄 Upload Policy Image</label>
            <input type="file" id="policy-file" accept="image/*" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600">
        </div>
        <p class="text-sm mb-4 info-message">📊 Formula rules are embedded in the system and will be automatically applied.</p>
        <button id="process-button" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700 disabled:bg-gray-400" disabled>🚀 Process Policy File</button>
    </div>

    <div class="main-content">
        <h1 class="text-3xl font-bold mb-4">🏢 Insurance Policy Processing System</h1>
        <hr class="mb-6 border-gray-300">

        <div id="initial-message" class="info-message">
            <p>👆 Please upload a policy image to begin processing.</p>
            <div class="mt-4">
                <h3 class="text-xl font-semibold">📋 Instructions:</h3>
                <ul class="list-disc pl-5">
                    <li><strong>Company Name</strong>: Enter the insurance company name</li>
                    <li><strong>Policy Image</strong>: Upload the image containing policy data (PNG, JPG, etc.)</li>
                    <li><strong>Process</strong>: Click the process button to extract data and calculate payouts</li>
                </ul>
                <h3 class="text-xl font-semibold mt-4">🎯 Features:</h3>
                <ul class="list-disc pl-5">
                    <li><strong>Image Support</strong>: PNG, JPG, JPEG, GIF, BMP, TIFF</li>
                    <li><strong>AI-Powered Extraction</strong>: Uses GPT-4o for intelligent text extraction via OCR</li>
                    <li><strong>Enhanced Remarks Extraction</strong>: Automatically detects and extracts vehicle make, age, transaction type, and validity dates</li>
                    <li><strong>Smart Formula Application</strong>: Uses embedded formula rules for accurate calculations</li>
                    <li><strong>Excel Export</strong>: Download processed data as formatted Excel file</li>
                </ul>
            </div>
        </div>

        <div id="processing-spinner" class="spinner"></div>
        <div id="error-message" class="error-message hidden"></div>
        <div id="success-message" class="success-message hidden"></div>

        <div id="results-container" class="hidden">
            <div class="flex mb-4">
                <button class="tab-button active" data-tab="tab1">📊 Final Results</button>
                <button class="tab-button" data-tab="tab2">📝 Extracted Text</button>
                <button class="tab-button" data-tab="tab3">🧾 Parsed Data</button>
                <button class="tab-button" data-tab="tab4">🧮 Calculated Data</button>
                <button class="tab-button" data-tab="tab5">📥 Download</button>
            </div>

            <div id="tab1" class="tab active">
                <h2 class="text-xl font-semibold mb-4">📊 Final Processed Data</h2>
                <div class="table-container">
                    <table id="results-table" class="w-full border-collapse border border-gray-300">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border border-gray-300 p-2">Segment</th>
                                <th class="border border-gray-300 p-2">Location</th>
                                <th class="border border-gray-300 p-2">Policy Type</th>
                                <th class="border border-gray-300 p-2">Payin</th>
                                <th class="border border-gray-300 p-2">Doable District</th>
                                <th class="border border-gray-300 p-2">Remarks</th>
                                <th class="border border-gray-300 p-2">Calculated Payout</th>
                                <th class="border border-gray-300 p-2">Formula Used</th>
                                <th class="border border-gray-300 p-2">Rule Explanation</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body"></tbody>
                    </table>
                </div>
                <div class="grid grid-cols-4 gap-4 mt-4">
                    <div class="bg-blue-100 p-4 rounded">
                        <p class="text-sm">Total Records</p>
                        <p id="total-records" class="text-lg font-bold">0</p>
                    </div>
                    <div class="bg-blue-100 p-4 rounded">
                        <p class="text-sm">Avg Payin</p>
                        <p id="avg-payin" class="text-lg font-bold">0.0%</p>
                    </div>
                    <div class="bg-blue-100 p-4 rounded">
                        <p class="text-sm">Unique Segments</p>
                        <p id="unique-segments" class="text-lg font-bold">0</p>
                    </div>
                    <div class="bg-blue-100 p-4 rounded">
                        <p class="text-sm">Company</p>
                        <p id="company-name-display" class="text-lg font-bold">Unknown Company</p>
                    </div>
                </div>
                <h2 class="text-xl font-semibold mt-4">🔧 Formula Rules Applied</h2>
                <ul id="formula-summary" class="list-disc pl-5"></ul>
            </div>

            <div id="tab2" class="tab">
                <h2 class="text-xl font-semibold mb-4">📝 Extracted Text from Policy Image</h2>
                <textarea id="extracted-text" class="w-full h-96 p-2 border border-gray-300 rounded" readonly></textarea>
                <h2 class="text-xl font-semibold mt-4">📊 Embedded Formula Rules</h2>
                <div class="table-container">
                    <table class="w-full border-collapse border border-gray-300">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border border-gray-300 p-2">LOB</th>
                                <th class="border border-gray-300 p-2">Segment</th>
                                <th class="border border-gray-300 p-2">Insurer</th>
                                <th class="border border-gray-300 p-2">PO</th>
                                <th class="border border-gray-300 p-2">Remarks</th>
                            </tr>
                        </thead>
                        <tbody id="formula-table-body">
                            <!-- Formula data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="tab3" class="tab">
                <h2 class="text-xl font-semibold mb-4">🧾 Parsed Policy Data</h2>
                <pre id="parsed-data" class="bg-gray-100 p-4 rounded overflow-auto max-h-96"></pre>
            </div>

            <div id="tab4" class="tab">
                <h2 class="text-xl font-semibold mb-4">🧮 Calculated Data with Formulas</h2>
                <pre id="calculated-data" class="bg-gray-100 p-4 rounded overflow-auto max-h-96"></pre>
                <h2 class="text-xl font-semibold mt-4">🔍 Rule Explanations</h2>
                <div id="rule-explanations"></div>
            </div>

            <div id="tab5" class="tab">
                <h2 class="text-xl font-semibold mb-4">📥 Download Results</h2>
                <div class="space-y-4">
                    <button id="download-excel" class="bg-green-600 text-white p-2 rounded hover:bg-green-700">📊 Download Excel File</button>
                    <button id="download-json" class="bg-green-600 text-white p-2 rounded hover:bg-green-700">📄 Download JSON Data</button>
                    <button id="download-csv" class="bg-green-600 text-white p-2 rounded hover:bg-green-700">📋 Download CSV File</button>
                    <p class="info-message">💡 The Excel file contains formatted data with company header and calculated payouts.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enable/disable process button based on file input
        document.getElementById('policy-file').addEventListener('change', function() {
            document.getElementById('process-button').disabled = !this.files.length;
        });

        // Tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                button.classList.add('active');
                document.getElementById(button.dataset.tab).classList.add('active');
            });
        });

        // Process button click
        document.getElementById('process-button').addEventListener('click', async () => {
            const companyName = document.getElementById('company-name').value;
            const policyFile = document.getElementById('policy-file').files[0];
            if (!policyFile) return;

            document.getElementById('initial-message').classList.add('hidden');
            document.getElementById('processing-spinner').style.display = 'block';
            document.getElementById('error-message').classList.add('hidden');
            document.getElementById('success-message').classList.add('hidden');
            document.getElementById('results-container').classList.add('hidden');

            const formData = new FormData();
            formData.append('company_name', companyName);
            formData.append('policy_file', policyFile);

            try {
                const response = await fetch('/process', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                document.getElementById('processing-spinner').style.display = 'none';

                if (response.ok) {
                    document.getElementById('success-message').textContent = '🎉 Processing completed successfully!';
                    document.getElementById('success-message').classList.remove('hidden');
                    document.getElementById('results-container').classList.remove('hidden');

                    // Populate Final Results
                    const resultsTableBody = document.getElementById('results-table-body');
                    resultsTableBody.innerHTML = '';
                    result.calculated_data.forEach(record => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="border border-gray-300 p-2">${record.Segment || 'N/A'}</td>
                            <td class="border border-gray-300 p-2">${record.Location || 'N/A'}</td>
                            <td class="border border-gray-300 p-2">${record['Policy Type'] || 'N/A'}</td>
                            <td class="border border-gray-300 p-2">${record.Payin || 'N/A'}</td>
                            <td class="border border-gray-300 p-2">${record['Doable District'] || 'N/A'}</td>
                            <td class="border border-gray-300 p-2">${record.Remarks || ''}</td>
                            <td class="border border-gray-300 p-2">${record['Calculated Payout'] || 'N/A'}</td>
                            <td class="border border-gray-300 p-2">${record['Formula Used'] || 'N/A'}</td>
                            <td class="border border-gray-300 p-2">${record['Rule Explanation'] || 'N/A'}</td>
                        `;
                        resultsTableBody.appendChild(row);
                    });

                    // Populate Metrics
                    document.getElementById('total-records').textContent = result.calculated_data.length;
                    document.getElementById('avg-payin').textContent = result.avg_payin ? `${result.avg_payin}%` : '0.0%';
                    document.getElementById('unique-segments').textContent = result.unique_segments || 0;
                    document.getElementById('company-name-display').textContent = companyName;

                    // Populate Formula Summary
                    const formulaSummary = document.getElementById('formula-summary');
                    formulaSummary.innerHTML = '';
                    Object.entries(result.formula_summary || {}).forEach(([formula, count]) => {
                        const li = document.createElement('li');
                        li.textContent = `• ${formula}: Applied to ${count} record(s)`;
                        formulaSummary.appendChild(li);
                    });

                    // Populate Extracted Text
                    document.getElementById('extracted-text').value = result.extracted_text || '';

                    // Populate Formula Table
                    const formulaTableBody = document.getElementById('formula-table-body');
                    formulaTableBody.innerHTML = '';
                    result.formula_data.forEach(rule => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="border border-gray-300 p-2">${rule.LOB}</td>
                            <td class="border border-gray-300 p-2">${rule.SEGMENT}</td>
                            <td class="border border-gray-300 p-2">${rule.INSURER}</td>
                            <td class="border border-gray-300 p-2">${rule.PO}</td>
                            <td class="border border-gray-300 p-2">${rule.REMARKS}</td>
                        `;
                        formulaTableBody.appendChild(row);
                    });

                    // Populate Parsed Data
                    document.getElementById('parsed-data').textContent = JSON.stringify(result.parsed_data, null, 2);

                    // Populate Calculated Data and Rule Explanations
                    document.getElementById('calculated-data').textContent = JSON.stringify(result.calculated_data, null, 2);
                    const ruleExplanations = document.getElementById('rule-explanations');
                    ruleExplanations.innerHTML = '';
                    result.calculated_data.forEach((record, index) => {
                        const div = document.createElement('div');
                        div.className = 'border border-gray-300 p-4 mb-2 rounded';
                        div.innerHTML = `
                            <h3 class="font-semibold">Record ${index + 1}: ${record.Segment || 'Unknown'}</h3>
                            <p><strong>Payin</strong>: ${record.Payin || 'N/A'}</p>
                            <p><strong>Calculated Payout</strong>: ${record['Calculated Payout'] || 'N/A'}</p>
                            <p><strong>Formula Used</strong>: ${record['Formula Used'] || 'N/A'}</p>
                            <p><strong>Rule Explanation</strong>: ${record['Rule Explanation'] || 'N/A'}</p>
                        `;
                        ruleExplanations.appendChild(div);
                    });

                    // Set up download buttons
                    document.getElementById('download-excel').onclick = () => {
                        const link = document.createElement('a');
                        link.href = `data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,${result.excel_data}`;
                        link.download = `${companyName}_processed_policies.xlsx`;
                        link.click();
                    };
                    document.getElementById('download-json').onclick = () => {
                        const link = document.createElement('a');
                        link.href = `data:application/json,${encodeURIComponent(JSON.stringify(result.calculated_data, null, 2))}`;
                        link.download = `${companyName}_processed_data.json`;
                        link.click();
                    };
                    document.getElementById('download-csv').onclick = () => {
                        const link = document.createElement('a');
                        link.href = `data:text/csv,${encodeURIComponent(result.csv_data)}`;
                        link.download = `${companyName}_processed_policies.csv`;
                        link.click();
                    };
                } else {
                    document.getElementById('error-message').textContent = `❌ ${result.error || 'Processing error'}`;
                    document.getElementById('error-message').classList.remove('hidden');
                }
            } catch (e) {
                document.getElementById('processing-spinner').style.display = 'none';
                document.getElementById('error-message').textContent = `❌ Error processing files: ${e.message}`;
                document.getElementById('error-message').classList.remove('hidden');
            }
        });
   
   </script>
</body>
</html>